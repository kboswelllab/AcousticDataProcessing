---
title: "Echoview Export Data Merging"
author: "Allison White"
date: "12/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Merge echoview exports from multiple EV files into one .csv file

This script will allow you to merge all .csv files stored in one folder based on the columns they have in common. This is useful in the case that the Echoview export properties were inconsistent across EV files from which you exported. 

Before you begin, save all .csv exports from Echoview in one folder and set this folder as your working directory using the function setwd().
```{r,echo=FALSE}
setwd("C:/Users/allwhite/Desktop/Autocorrelation/Manuscript/nasc5x5_2017/")
```

Create a list of the files in this folder.
```{r}
file.list<-list.files(path = "C:/Users/allwhite/Desktop/Autocorrelation/Manuscript/nasc5x5_2017/")
file.list
```

Now make some empty lists to store each file in. We'll make one to store the files as dataframes, one to store the column names of each file, and one to store the dataframe containing only the columns that they all have in common.
```{r}
allfiles<-vector('list',length=length(file.list)) #will store each file as a dataframe
columns<-vector('list',length=length(file.list)) #will store the column names in each dataframe
mergedfiles<-vector('list',length=length(file.list)) #will store each dataframe with only the columns that they all have in common
```

Next, make a loop where each iteration will store a file in your folder as a dataframe in the list "allfiles" and the column names of that file in the list "columns".
```{r}
for(i in 1:length(file.list)){
  file.i<-read.csv(file.list[i]) #opens the ith .csv file
  file.i$file_name<-file.list[i] #adds a new column to each dataframe which contains the name of the original file
  file.i$site<-i #adds a new column to each dataframe which assigns a number to each file
  allfiles[[i]]<-file.i #stores the ith dataframe as the ith element in the list "allfiles"
  columns[[i]]<-colnames(file.i) #stores the column names of the ith dataframe as the ith element in the list "columns"
  
  #Print the number of column names in each file to see if they match
  print(length(colnames(file.i)))
}
```
By printing the number of column names in each file we can see that the 8th .csv file has one more column than the other 7 .csv files in this folder. As there are 99 columns in every other folder, it might take us some time to manually go through and find which column didn't match. Instead, we'll let R do it for us!

Find the column names that the 8 .csv files have in common and store these names as a list called "common.columns".
```{r}
common.columns<-Reduce(intersect,list(columns[[1]],columns[[2]],columns[[3]],columns[[4]],columns[[5]],columns[[6]],columns[[7]],columns[[8]])) #You will have to change the number of columns[[]] here based on how many files you are merging.
```

This gives us a list of the column names that all files have in common.
```{r}
common.columns
```

Now we can write a loop to subset each dataframe by the common.columns list and store these dataframes containing only columns that all the files have in the list "mergedfiles" that we created earlier.
```{r}
for(i in 1:length(file.list)){
  file.i<-allfiles[[i]]
  m.file.i<-file.i[,common.columns]
  print(length(colnames(m.file.i)))
  mergedfiles[[i]]<-m.file.i
}
```
The number of columns should now be the same for all files.

Bind the subsetted dataframes by row into one dataframe.
```{r}
merged.data<-as.data.frame(do.call(rbind,mergedfiles))
```

Check to make sure that this worked by printing the last 6 rows of your combined data. 
```{r}
tail(merged.data)
```
Scroll to the last few columns in your datframe. You'll know that the merging worked if the values in the last four or so columns look reasonable for the variables they represent.

Finally, save your merged dataframe as a .csv file. In this example, the data has been saved in the folder "Manuscript" as "5x5nasc_2017".
```{r,echo=FALSE}
write.csv(merged.data,'C:/Users/allwhite/Desktop/Autocorrelation/Manuscript/5x5nasc_2017.csv')
```